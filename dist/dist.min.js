function Colisor(){this.sprites=[],this.aoColidir=null,this.spritesExcluir=[]}Colisor.prototype={novoSprite:function(i){this.sprites.push(i),i.colisor=this},processar:function(){var i,t,s,o={};for(i in this.sprites)for(var a in this.sprites)i!=a&&(t=this.stringUnica(this.sprites[i]),s=this.stringUnica(this.sprites[a]),o[t]||(o[t]=[]),o[s]||(o[s]=[]),0<=o[t].indexOf(s)||0<=o[s].indexOf(t)||(this.testarColisao(this.sprites[i],this.sprites[a]),o[t].push(s),o[s].push(t)));this.processarExclusoes()},testarColisao:function(i,t){var s=i.retangulosColisao(),o=t.retangulosColisao();i:for(var a in s)for(var e in o)if(this.retangulosColidem(s[a],o[e])){i.colidiuCom(t),t.colidiuCom(i),this.aoColidir&&this.aoColidir(i,t);break i}},retangulosColidem:function(i,t){return i.x+i.largura>t.x&&i.x<t.x+t.largura&&i.y+i.altura>t.y&&i.y<t.y+t.altura},stringUnica:function(i){var t,s="",o=i.retangulosColisao();for(t in o)s+="x:"+o[t].x+",y:"+o[t].y+",l:"+o[t].largura+",a:"+o[t].altura+"\n";return s},excluirSprite:function(i){this.spritesExcluir.push(i)},processarExclusoes:function(){var i,t=[];for(i in this.sprites)-1==this.spritesExcluir.indexOf(this.sprites[i])&&t.push(this.sprites[i]);this.spritesExcluir=[],this.sprites=t}};var SOM_EXPLOSAO=new Audio;function Explosao(i,t,s,o){this.context=i,this.imagem=t,this.x=s,this.y=o,this.spritesheet=new Spritesheet(i,t,1,5),this.spritesheet.intervalo=75;var a=this;this.fimDaExplosao=null,this.spritesheet.fimDoCiclo=function(){a.animador.excluirSprite(a),a.fimDaExplosao&&a.fimDaExplosao()},SOM_EXPLOSAO.currentTime=0,SOM_EXPLOSAO.play()}function Fundo(i,t,s){this.context=i,this.imagem=t,this.velocidade=s,this.posicaoEmenda=0}SOM_EXPLOSAO.src="sons/explosao.mp3",SOM_EXPLOSAO.volume=.4,SOM_EXPLOSAO.load(),Explosao.prototype={atualizar:function(){},desenhar:function(){this.spritesheet.desenhar(this.x,this.y),this.spritesheet.proximoQuadro()}},Fundo.prototype={atualizar:function(){this.posicaoEmenda+=this.velocidade*this.animador.decorrido/1e3,this.posicaoEmenda>this.imagem.height&&(this.posicaoEmenda=0)},desenhar:function(){var i=this.imagem,t=this.posicaoEmenda-i.height;this.context.drawImage(i,0,t,i.width,i.height),t=this.posicaoEmenda,this.context.drawImage(i,0,t,i.width,i.height)}};var SOM_TIRO=new Audio;function Nave(i,t,s,o,a,e,n){this.context=i,this.teclado=t,this.imagem=s,this.animador={},this.x=o,this.y=a,this.velocidade=e,this.vidas=3,this.acabaramAsVidas=null,this.imgExplosao=n,this.spriteSheet=new Spritesheet(i,s,3,2),this.spriteSheet.linha=0,this.spriteSheet.intervalo=100,this.ativarTiro=!0}function Ovni(i,t,s){this.context=i,this.imagem=t,this.x=0,this.y=0,this.velocidade=0,this.imgExplosao=s}function Painel(i,t){this.context=i,this.nave=t,this.spritesheet=new Spritesheet(i,t.imagem,3,2),this.spritesheet.linha=0,this.spritesheet.coluna=0,this.pontuacao=0}SOM_TIRO.src="sons/tiro.mp3",SOM_TIRO.volume=.2,SOM_TIRO.load(),Nave.prototype={atualizar:function(){var i=this,t=this.velocidade*this.animador.decorrido/1e3;this.teclado.pressionada(SETA_ESQUERDA)&&0<this.x&&(this.x-=t),this.teclado.pressionada(SETA_DIREITA)&&this.x<this.context.canvas.width-36&&(this.x+=t),this.teclado.pressionada(SETA_CIMA)&&0<this.y&&(this.y-=t),this.teclado.pressionada(SETA_BAIXO)&&this.y<this.context.canvas.height-48&&(this.y+=t),this.teclado.disparou(ESPACO,function(){i.atirar()})},desenhar:function(){this.teclado.pressionada(SETA_ESQUERDA)?this.spriteSheet.linha=1:this.teclado.pressionada(SETA_DIREITA)?this.spriteSheet.linha=2:this.spriteSheet.linha=0,this.spriteSheet.desenhar(this.x,this.y),this.spriteSheet.proximoQuadro()},atirar:function(){var i;this.ativarTiro&&(SOM_TIRO.currentTime=0,SOM_TIRO.play(),i=new Tiro(this.context,this,"blue"),this.animador.novoSprite(i),this.colisor.novoSprite(i))},retangulosColisao:function(){return[{x:this.x,y:this.y+18,largura:15,altura:14},{x:this.x+20,y:this.y+18,largura:15,altura:14},{x:this.x+15,y:this.y,largura:5,altura:48}]},desenharRetangulosDeColisao:function(){for(var i=this.context,t=(i.save(),i.strokeStyle="yellow",this.retangulosColisao()),s=0,o=t.length;s<o;s++){var a=t[s];i.strokeRect(a.x,a.y,a.largura,a.altura)}i.restore()},colidiuCom:function(i){var t,s;i instanceof Ovni&&(this.animador.excluirSprite(this),this.animador.excluirSprite(i),this.colisor.excluirSprite(this),this.colisor.excluirSprite(i),t=new Explosao(this.context,this.imgExplosao,this.x,this.y),i=new Explosao(this.context,this.imgExplosao,i.x,i.y),this.animador.novoSprite(t),this.animador.novoSprite(i),s=this,t.fimDaExplosao=function(){s.vidas--,0===s.vidas?s.acabaramAsVidas&&s.acabaramAsVidas():(s.colisor.novoSprite(s),s.animador.novoSprite(s),s.posicionar())})},posicionar:function(){var i=this.context.canvas;this.x=i.width/2-18,this.y=i.height-48}},Ovni.prototype={atualizar:function(){this.y+=this.velocidade*this.animador.decorrido/1e3,this.y>this.context.canvas.height&&(this.animador.excluirSprite(this),this.colisor.excluirSprite(this))},desenhar:function(){var i=this.context,t=this.imagem;i.drawImage(t,this.x,this.y,t.width,t.height)},retangulosColisao:function(){return[{x:this.x,y:this.y+10,largura:this.imagem.width,altura:this.imagem.height-20},{x:this.x+20,y:this.y,largura:28,altura:10},{x:this.x+18,y:this.y+22,largura:28,altura:10}]},desenharRetangulosDeColisao:function(){for(var i=this.context,t=(i.save(),i.strokeStyle="yellow",this.retangulosColisao()),s=0,o=t.length;s<o;s++){var a=t[s];i.strokeRect(a.x,a.y,a.largura,a.altura)}i.restore()},colidiuCom:function(i){i instanceof Tiro&&(this.animador.excluirSprite(this),this.colisor.excluirSprite(this),this.animador.excluirSprite(i),this.colisor.excluirSprite(i),i=new Explosao(this.context,this.imgExplosao,this.x,this.y),this.animador.novoSprite(i))}},Painel.prototype={atualizar:function(){},desenhar:function(){for(var i=this.context,t=20,s=0;s<this.nave.vidas;s++)this.spritesheet.desenhar(t,20),t+=40;i.save(),i.fillStyle="white",i.font="18px sans-serif",i.fillText("Pontos: "+this.pontuacao,200,27),i.restore()}};var SETA_ESQUERDA=37,SETA_DIREITA=39,SETA_CIMA=38,SETA_BAIXO=40,ESPACO=32,ENTER=13;function Teclado(i){var t=this;t.elemento=i,t.pressionadas=[],t.disparadas=[],t.funcoesDisparo=[],i.addEventListener("keydown",function(i){i=i.keyCode;t.pressionadas[i]=!0,t.funcoesDisparo[i]&&!t.disparadas[i]&&(t.disparadas[i]=!0,t.funcoesDisparo[i]())}),i.addEventListener("keyup",function(i){i=i.keyCode;t.pressionadas[i]=!1,t.disparadas[i]=!1})}function Tiro(i,t,s){this.context=i,this.nave=t,this.largura=4,this.altura=20,this.x=t.x+18,this.y=t.y-this.altura,this.velocidade=600,this.cor=s}function Animador(i){this.context=i,this.ligado=!1,this.sprites=[],this.spriteExcluir=[],this.processamentos=[],this.processamentosExcluir=[],this.ultimoCiclo=0,this.decorrido=0}Teclado.prototype={pressionada:function(i){return this.pressionadas[i]},disparou:function(i,t){this.funcoesDisparo[i]=t}},Tiro.prototype={atualizar:function(){this.y-=this.velocidade*this.animador.decorrido/1e3,this.y<0&&(this.animador.excluirSprite(this),this.colisor.excluirSprite(this))},desenhar:function(){var i=this.context;i.save(),i.fillStyle=this.cor,i.fillRect(this.x,this.y,this.largura,this.altura),i.restore()},retangulosColisao:function(){return[{x:this.x,y:this.y,largura:this.largura,altura:this.altura}]},desenharRetangulosDeColisao:function(){for(var i=this.context,t=(i.save(),i.strokeStyle="yellow",this.retangulosColisao()),s=0,o=t.length;s<o;s++){var a=t[s];i.strokeRect(a.x,a.y,a.largura,a.altura)}i.restore()},colidiuCom:function(i){}},Animador.prototype={novoSprite:function(i){this.sprites.push(i),i.animador=this},novoProcessamento:function(i){this.processamentos.push(i),i.animador=this},ligar:function(){this.ligado=!0,this.ultimoCiclo=0,this.proximoFrame()},desligar:function(){this.ligado=!1},proximoFrame:function(){if(this.ligado){for(var i=(new Date).getTime(),t=(0===this.ultimoCiclo&&(this.ultimoCiclo=i),this.decorrido=i-this.ultimoCiclo,this),s=0,o=this.sprites.length,a=this.processamentos.length;s<o;s++)t.sprites[s].atualizar();for(s=0;s<o;s++)t.sprites[s].desenhar();for(s=0;s<a;s++)t.processamentos[s].processar();t.processarExclusoes(),this.ultimoCiclo=i,requestAnimationFrame(function(){t.proximoFrame()})}},limparTela:function(){this.context.clearRect(0,0,this.context.canvas.width,this.context.canvas.height)},excluirSprite:function(i){this.spriteExcluir.push(i)},excluirProcessamento:function(i){this.excluirProcessamento.push(i)},processarExclusoes:function(){for(var i=[],t=[],s=0,o=this.sprites.length,a=this.processamentos.length;s<o;s++)-1==this.spriteExcluir.indexOf(this.sprites[s])&&i.push(this.sprites[s]);for(s=0;s<a;s++)-1==this.processamentosExcluir.indexOf(this.processamentos[s])&&t.push(this.processamentos[s]);this.spriteExcluir=[],this.processamentosExcluir=[],this.sprites=i,this.processamentos=t}};var canvas=document.getElementById("myCanvas"),context=canvas.getContext("2d"),btnJogar=document.getElementById("link_jogar"),imagens=[],animador={},teclado={},colisor={},nuvens={},estrelas={},espaco={},nave={},inimigo={},totalImagens=0,imagensCarregadas=0,musicaAcao=null,painel=null;function mostrarLinkJogar(){btnJogar.style.display="block"}function iniciarJogo(){criadorInimigos.ultimoOvni=(new Date).getTime(),btnJogar.style.display="none",musicaAcao.play(),animador.ligar(),nave.ativarTiro=!0,painel.pontuacao=0,teclado.disparou(ENTER,pausarJogo)}function carregarMusicas(){(musicaAcao=new Audio).src="sons/musica-acao.mp3",musicaAcao.load(),musicaAcao.volume=.5,musicaAcao.loop=!0}function carregarImagens(){for(var i in imagens={espaco:"fundo-espaco.png",estrelas:"fundo-estrelas.png",nuvens:"fundo-estrelas.png",nave:"nave-spritesheet.png",ovni:"ovni.png",explosao:"explosao.png"}){var t=new Image;t.src="images/"+imagens[i],t.onload=carregando,imagens[i]=t,totalImagens++}}function carregando(){context.save(),context.drawImage(imagens.espaco,0,0,canvas.width,canvas.height),context.fillStyle="white",context.strokeStyle="black",context.font="50px sans-serif",context.fillText("Carregando...",100,200),context.strokeText("Carregando",100,200);var i=++imagensCarregadas/totalImagens*300;context.fillStyle="yellow",context.fillRect(100,250,i,50),context.restore(),imagensCarregadas===totalImagens&&iniciarObjetos()}function iniciarObjetos(){animador=new Animador(context),teclado=new Teclado(document),colisor=new Colisor,espaco=new Fundo(context,imagens.espaco,60),estrelas=new Fundo(context,imagens.estrelas,150),nuvens=new Fundo(context,imagens.nuvens,400),nave=new Nave(context,teclado,imagens.nave,canvas.width/2-18,canvas.height-48,250,imagens.explosao),painel=new Painel(context,nave),animador.novoSprite(espaco),animador.novoSprite(estrelas),animador.novoSprite(nuvens),animador.novoSprite(nave),animador.novoSprite(painel),colisor.novoSprite(nave),animador.novoProcessamento(colisor),criacaoInimigos(),painel.pontuacao=0,colisor.aoColidir=function(i,t){(i instanceof Tiro&&t instanceof Ovni||i instanceof Ovni&&t instanceof Tiro)&&(painel.pontuacao+=10)},mostrarLinkJogar(),teclado.disparou(ENTER,iniciarJogo),nave.acabaramAsVidas=function(){animador.desligar(),gameOver()}}function gameOver(){nave.ativarTiro=!1,teclado.disparou(ENTER,null),musicaAcao.pause(),musicaAcao.currentTime=0,removerInimigos(),context.drawImage(imagens.espaco,0,0,canvas.width,canvas.height),context.save(),context.fillStyle="white",context.strokeStyle="black",context.font="70px sans-serif",context.fillText("Game Over",40,200),context.strokeText("Game Over",40,200),context.restore(),mostrarLinkJogar(),nave.vidas=3,nave.posicionar(),animador.novoSprite(nave),colisor.novoSprite(nave)}function removerInimigos(){for(var i in animador.sprites)animador.sprites[i]instanceof Ovni&&animador.excluirSprite(animador.sprites[i]);for(var i in colisor.sprites)colisor.sprites[i]instanceof Ovni&&colisor.excluirSprite(animador.sprites[i])}function criacaoInimigos(){criadorInimigos={ultimoOvni:(new Date).getTime(),processar:function(){var i=(new Date).getTime();1e3<i-this.ultimoOvni&&(novoOvni(),this.ultimoOvni=i)}},animador.novoProcessamento(criadorInimigos)}function novoOvni(){var i=new Ovni(context,imagens.ovni,imagens.explosao);i.x=Math.floor(Math.random()*(context.canvas.width-imagens.ovni.width+1)),i.y=imagens.ovni.height,i.velocidade=Math.floor(500*Math.random())+150,colisor.novoSprite(i),animador.novoSprite(i)}function pausarJogo(){animador.ligado?(animador.desligar(),nave.ativarTiro=!1,context.save(),context.fillStyle="white",context.strokeStyle="black",context.font="50px sans-serif",context.fillText("Pausado",160,200),context.strokeText("Pausado",160,200),context.restore(),musicaAcao.pause()):(criadorInimigos.ultimoOvni=(new Date).getTime(),animador.ligar(),nave.ativarTiro=!0,musicaAcao.play())}function Bola(i,t,s,o,a){this.context=i,this.x=t,this.y=s,this.r=o,this.cor=a,this.vx=3,this.vy=2}function Spritesheet(i,t,s,o){this.context=i,this.imagem=t,this.numLinhas=s,this.numColunas=o,this.intervalo=0,this.linha=0,this.coluna=0,this.fimDoCiclo=null}carregarImagens(),carregarMusicas(),Bola.prototype={atualizar:function(){var i=this,t=this.context.canvas.width,s=this.context.canvas.height;(i.x<i.r||i.x>t-i.r)&&(i.vx*=-1),(i.y<i.r||i.y>s-i.r)&&(i.vy*=-1),i.x+=i.vx,i.y+=i.vy},desenhar:function(){var i=this.context;i.save(),i.fillStyle=this.cor,i.beginPath(),i.arc(this.x,this.y,this.r,0,2*Math.PI,!1),i.fill(),i.restore()},retangulosColisao:function(){var i=this;return console.log(i.x),[{x:i.x-i.r,y:i.y-i.r,largura:2*i.r,altura:2*i.r}]},colidiuCom:function(i){this.vx*=-1,this.vy*=-1}},Spritesheet.prototype={proximoQuadro:function(){var i=(new Date).getTime();this.ultimoTempo||(this.ultimoTempo=i),i-this.ultimoTempo<this.intervalo||(this.coluna<this.numColunas-1?this.coluna++:(this.coluna=0,this.fimDoCiclo&&this.fimDoCiclo()),this.ultimoTempo=i)},desenhar:function(i,t){var s=this.imagem.width/this.numColunas,o=this.imagem.height/this.numLinhas;this.context.drawImage(this.imagem,s*this.coluna,o*this.linha,s,o,i,t,s,o)}};